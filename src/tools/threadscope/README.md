#Threadscope Documentation


Threadscope is used for visualizing a profiled trace of a multithreaded program.  It was [originally written for Haskell](https://hackage.haskell.org/package/threadscope), but has been ported to be used for Manticore programs.  


Installing the Event Parser
-
Threadscope is written in Haskell and depends on a number of packages, which can be installed using Haskell's package manager, [cabal](https://wiki.haskell.org/Cabal/How_to_install_a_Cabal_package).  Most importantly, Threadscope depends on the `ghc-events` package.  We have a modified version of this package in the Manticore repository, which must be used instead of the one hosted on Hackage.  In order to install Manticore's version of `ghc-events`, you must first run the `configure` script, which will generate a number of files used in the package.  After this, simply:

    cd <path to Manticore>/trunk/src/tools/event-parser
    cabal install
    
Installing Threadscope
-
After having installed the event parser:

    cd <path to Manticore>/trunk/src/tools/threadscope
    cabal install
    
Troubleshooting
-
####Missing System Packages
Errors of the form

    setup: The program 'pkg-config' version >=<version number> is required but it could not
    be found.
    Failed to install <lib-name>
    
`pkg-config` is used by Cabal to determine if a given system package is installed on your machine.  This error indicates that you are missing a system package.  Install it with `apt-get` (or `brew`/`port` on Mac).  You will probably need to do this for `gtk` and `cairo` (possibly more...)

####Build Errors with Hackage GTK Package

On Mac you might see the following errors when installing the `gtk` package from Hackage:

    [ 22 of 209] Compiling Graphics.UI.Gtk.Embedding.Plug 
    ( dist/build/Graphics/UI/Gtk/Embedding/Plug.hs, 
    dist/build/Graphics/UI/Gtk/Embedding/Plug.o )

    Graphics/UI/Gtk/Embedding/Plug.chs:120:6: error:
    Couldn't match expected type ‘Ptr ()’
                with actual type ‘Maybe DrawWindow’
    In the first argument of ‘gtk_plug_new’, namely
      ‘(fromNativeWindowId (fromMaybe nativeWindowIdNone socketId))’
    In the second argument of ‘($)’, namely
      ‘gtk_plug_new
         (fromNativeWindowId (fromMaybe nativeWindowIdNone socketId))’
    ...
    
Add the `-fhave-quartz-gtk` flag [[1](http://stackoverflow.com/questions/31999191/cabal-install-gtk-failing)] [[2](https://github.com/gtk2hs/gtk2hs/issues/121)]:

    cabal install gtk -fhave-quartz-gtk
    
Using Threadscope / Logging Infrastructure
-
  1. `pmlc -log <other-flags> <program>`
    
  2. `./<prog>` or `./<prog> -log <filename>`
  3. `threadscope LOG` or `threadscope <filename>` respectively
  
Adding New Events
-
There is a JSON file containing all of the event information in `trunk/config/log-events.json`.  An event is of the form:

    { "name" : "<EventName>",
	  "args" : [{"name" : "<argName>", "ty" : "<argType>", "desc" : "<ArgDescription>"}*],
	  "desc" : "<description of event>",
	  "attrs" : ["rt"],
	  "format" : "<FormatStr>", /* Used for formatting the output of an event  
	                             * (can mention any args by name)
	                             * This is an optional field.  If it is not
	                             * present then, the "desc" field is used
	                             */
	  "color" : "<color>"       /* If this is present, then a mark will 
	                             * show up on the Threadscope timeline with
	                             * the given color. 
	                             */
    }

The "attrs" field can be:

  1. "src" - this event is the source of a dependent event and has a new-id argument.
  2. "pml" - this event is only generated by PML/BOM code
  3. "rt" - this event is only generated by C code
  4. "ghc" - this event is one of the predefined GHC events that Threadscope knows about.  (Chances are you shouldn't use this).
  
As an example, the event corresponding to the end of a major garbage collection might look something like:

    { "name" : "MajorGCEnd",
	  "args" : [
	    {"name" : "nCopiedBytes", "ty" : "word", "desc" : "number of live bytes copied"},
	    {"name" : "nAvailBytes", "ty" : "word", "desc" : "number of bytes available for allocation"}
	    ],
	  "attrs" : ["rt"],
	  "desc" : "major GC ends",
	  "format" : "\"Major GC copied %u bytes with %u bytes available for allocation\" nCopiedBytes nAvailBytes",
	  "color" : "red"
    }
    
You should not add any color attribute to the `StartGC`, `EndGC`, `RunThread`, or `StopThread` events.  They have a special meaning in Threadscope and are treated as a "duration" event which covers a range of time.
    
Note that after adding new events.  You will need to either re-run the `configure` script or

    cd <manticore-prefix>/trunk/src/gen/log-gen
    make local-install
    cd <manticore-prefix>/trunk/bin
    ./log-gen
	cd <manticore-prefix>/trunk/src/tools    
    cabal install event-parser/
    cabal install threadscope/
    
