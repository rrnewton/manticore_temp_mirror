#!/bin/bash
#

MC="sml @SMLcmdname=mc @SMLload=../../mc"
MCFLAGS=""
LOG=out

rm -f $LOG

# allow core dumps
ulimit -c unlimited

for f in *.pml
do
  fname=${f%.pml}
  if [ -e "$fname.ok" ] ; then
    echo -n "checking $fname ... "
    $MC $MCFLAGS $f 2> /dev/null
    if [ "$?" -eq "0" ] ; then
      ./a.out > $fname.test
      diffs=$(diff $fname.test $fname.ok)
      status=$(diff $fname.test $fname.ok | wc -l)
      if [ $status -eq "0" ] ; then
	echo "***** Check succeeded for $f." >> $LOG
	echo "ok"
      else
	echo "***** Check failed for $f." >> $LOG
	diff $fname.test $fname.ok >> $LOG
	echo "fail"
      fi
    else
      echo "***** Compile failed for $f." >> $LOG
      echo "fail"
    fi
    rm -f a.out $fname.s $fname.test
  fi
done
