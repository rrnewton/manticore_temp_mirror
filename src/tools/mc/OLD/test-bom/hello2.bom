(* hello2.bom
 * mix C calls with garbage collections *)

module Hi
  extern void printInt (int); 
  fun init (arg : [int]; exh : cont(any)) : unit =

      fun fib (i : int; exh : cont(any)) : int =
	  if I32Lte(i, 0:int) then return (0:int)
	  else if I32Eq(i, 1:int) then return (1:int)
	  else
	    let a : int = apply fib (I32Sub(i, 2: int); exh)
	    let b : int = apply fib (I32Sub(i, 1: int); exh)
	    return (I32Add(a, b))

      fun printn (i : int; exh : cont(any)) : int =
	  if I32Eq (i, 0:int) 
	  then return (0: int)
	  else
	      let () = ccall printInt (i)	     
  	      apply printn (I32Sub (i, 1:int); exh)
	                    
      fun doit (i : int; exh: cont(any)) : int = 
          let n : int = apply fib (i; exh)
          apply printn (n; exh)

      return (enum(0))
