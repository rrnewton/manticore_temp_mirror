#!/bin/bash
#
# COPYRIGHT (c) 2008 The Manticore Project (http://manticore.cs.uchicago.edu)
# All rights reserved.
#

DIR=`pwd`
MC="sml @SMLcmdname=mc @SMLload=$DIR/../../src/tools/mc/mc"
MCFLAGS="-Csequential=true -Cclos.convert-style=flatWithCFA"
DATE=$( date +"%F-%H-%M-%S" )
REPORT_FILE=report-$DATE
REPORT="$DIR/reports/$REPORT_FILE"
LOG="$DIR/LOG"
status=""

# allow core dumps
ulimit -c unlimited

( cd goals;

rm -rf $LOG

for g in basics seq-* 
do
( cd $g;
   for f in *.pml *.mlb
   do
     fname=${f%.*}
     if [ -e "$fname.ok" ] ; then
       echo -n "checking $g/$f ..."
       echo "checking $g/$f" >> $LOG
       $MC $MCFLAGS $f 2>> $LOG
       if [ "$?" -eq "0" ] ; then
	 ./a.out > $fname.test
	 diffs=$(diff $fname.test $fname.ok)
	 status=$(diff $fname.test $fname.ok | wc -l)
	 if [ $status -eq "0" ] ; then
	   echo "***** Check succeeded for goal $g in file $f." >> $REPORT
	   echo "ok" >> $LOG
	   echo "ok"
	 else
	   echo "***** Check failed for goal $g in file $f." >> $REPORT
           status="$g/$f failed $status."
	   diff $fname.test $fname.ok >> $REPORT
	   echo "fail" >> $LOG
	   echo "fail"
	 fi
       else
	 echo "***** Compile failed for goal $g in file $f." >> $REPORT
         status="$g/$f failed $status."
	 echo "fail" >> $LOG
	 echo "fail"
       fi
       rm -f a.out $fname.s $fname.test
     fi
   done
)
done

)
echo $status >> $LOG
echo $status
echo "Report available at: $REPORT"
