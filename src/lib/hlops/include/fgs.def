(* fgs.def
 *
 * COPYRIGHT (c) 2007 The Manticore Project (http://manticore.cs.uchicago.edu)
 * All rights reserved.
 *
 * Types and HLops for fiber-group storage.
 *)

#ifndef _FGS_DEF_
#define _FGS_DEF_

#include "runtime-offsets.def"
#include "types.def"

(* [lock, killed, pinned, parent fgs (optional), auxilliary storage]
 *)
typedef fgs = ![bool, bool, bool, option, assoc_list];
typedef tid = fgs;

#define FGS_ALIST_OFFSET     4
#define FGS_LOCK_OFFSET      0
#define FGS_PARENT_OFFSET    3

define @new-fgs (pinned : bool, parent : option / exh : exh) : fgs;
define @get-fgs (vp : vproc / exh : exh) : fgs;
define inline @set-fgs (vp : vproc, fgs : fgs / exh : exh) : unit;

(** Unique fiber ids **)
typedef fid = int;
define @get-fid (vp : vproc / exh : exh) : fid;

(** Assocation lists **)

(* assoc-list-lookup: lookup a tag in the association list, initializing it if necessary.
 * - atag: tag to lookup
 * - init: function that initializes the item if none exists
 * - fgs: fiber group storage that contains the assoication list
 *)
define @assoc-list-lookup (atag : assoc_tag, init : fun(unit / exh -> any), fgs : fgs / exh : exh) : any;
(* assoc-list-query: returns the value assocated with atag in fgs, if it exists.
 * - atag: tag to lookup
 * - fgs: fiber group storage that contains the assoication list
 *)
define @assoc-list-query (atag : assoc_tag, fgs : fgs / exh : exh) : option;
(* assoc-list-add: add atag to the assocation list it does not already exist, and return the assoicated value.  
 *                 IMPORTANT: the caller must use the return elt in place of elt, since we promote the former.
 *   - atag: tag to add
 *   - elt: value to add
 *   - fgs: fiber group storage that contains the assoication list
 *)
define @assoc-list-add (atag : assoc_tag, elt : any, fgs : fgs / exh : exh) : any;
(* assoc-list-find: returns the associated value of a tag in alist.
 * - atag: tag to find
 * - alist: association list
 *)
define @assoc-list-find (atag : assoc_tag, alist : assoc_list / exh : exh) : option;

define @assoc-list-modify (atag : assoc_tag, elt : any, fgs : fgs / exh : exh) : any;

(** UIDs **)
define inline @get-uid (uidTag : assoc_tag, vp : vproc / exh : exh) : int;

#endif /*! _FGS_DEF_ */
